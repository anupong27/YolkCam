<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏µ‡πÑ‡∏Ç‡πà‡πÅ‡∏î‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ </title>

  <!-- ‡πÇ‡∏´‡∏•‡∏î OpenCV.js -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

  <!-- ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
  <style>
    body {
      font-family: "Prompt", sans-serif;
      background: #fdfdfd;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    header {
      background: linear-gradient(90deg, #ff9800, #f44336);
      color: white;
      padding: 20px 0;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    main {
      margin: 20px auto;
      max-width: 800px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    canvas {
      width: 100%;
      max-width: 700px;
      border-radius: 12px;
      border: 2px solid #ccc;
      margin-top: 10px;
    }

    #controls {
      margin-top: 15px;
    }

    button {
      margin: 5px;
      padding: 10px 18px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      opacity: 0.85;
    }

    #useCamera {
      background-color: #ff9800;
      color: white;
    }

    #useImage {
      background-color: #4caf50;
      color: white;
    }

    #analyzeYolk {
      background-color: #2196f3;
      color: white;
    }

    #colorResult,
    #rocheResult {
      font-size: 1.1rem;
      margin-top: 10px;
    }

    #shadePreview {
      width: 60px;
      height: 60px;
      margin: 10px auto;
      border-radius: 50%;
      border: 2px solid #999;
    }

    #errorMessage {
      color: red;
      margin-top: 10px;
      display: none;
    }

    footer {
      margin-top: 30px;
      color: #666;
      font-size: 0.9rem;
    }

    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>

  <header>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏µ‡πÑ‡∏Ç‡πà‡πÅ‡∏î‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ </header>

  <main>
    <h3>üì∏ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏†‡∏≤‡∏û</h3>
    <div id="controls">
      <button id="useCamera">üé• ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
      <button id="useImage">üñºÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û</button>
      <button id="analyzeYolk">üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÑ‡∏Ç‡πà‡πÅ‡∏î‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (CVS)</button>
    </div>

    <input type="file" id="imageInput" accept="image/*" />

    <canvas id="canvas" width="640" height="480"></canvas>

    <div id="shadePreview"></div>

    <div id="colorResult">üñ±Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</div>
    <div id="rocheResult">üìä ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏µ‡πÑ‡∏Ç‡πà‡πÅ‡∏î‡∏á: -</div>
    <div id="errorMessage"></div>
  </main>

  <footer>
    ¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏µ‡πÑ‡∏Ç‡πà‡πÅ‡∏î‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‚Äî ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏ô‡∏≤‡∏¢‡∏≠‡∏ô‡∏∏‡∏û‡∏á‡∏©‡πå ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏ò‡∏™‡∏á
  </footer>

  <!-- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ script ‡∏´‡∏•‡∏±‡∏Å -->
  <script src="script.js"></script>

  <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô OpenCV -->
  <script>
    const analyzeYolkBtn = document.getElementById("analyzeYolk");

    analyzeYolkBtn.addEventListener("click", async () => {
      errorMessage.style.display = "none";

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ OpenCV ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
      if (typeof cv === "undefined" || !cv.Mat) {
        errorMessage.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î OpenCV.js ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...";
        errorMessage.style.display = "block";
        return;
      }

      analyzeYolkRegion();
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÑ‡∏Ç‡πà‡πÅ‡∏î‡∏á‡∏î‡πâ‡∏ß‡∏¢ OpenCV.js
    async function analyzeYolkRegion() {
      if (!ctx || (!loadedImage && !videoStream)) {
        errorMessage.textContent = "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô";
        errorMessage.style.display = "block";
        return;
      }

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      let src = cv.matFromImageData(imageData);
      let dst = new cv.Mat();
      let mask = new cv.Mat();

      try {
        cv.cvtColor(src, dst, cv.COLOR_RGBA2BGR);
        cv.cvtColor(dst, dst, cv.COLOR_BGR2HSV);

        // ‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡πÑ‡∏Ç‡πà‡πÅ‡∏î‡∏á (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á-‡∏™‡πâ‡∏°)
        const lower = new cv.Mat(dst.rows, dst.cols, dst.type(), [10, 60, 80, 0]);
        const upper = new cv.Mat(dst.rows, dst.cols, dst.type(), [35, 255, 255, 255]);

        cv.inRange(dst, lower, upper, mask);
        cv.GaussianBlur(mask, mask, new cv.Size(9, 9), 2, 2);

        let contours = new cv.MatVector();
        let hierarchy = new cv.Mat();
        cv.findContours(mask, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

        let largestContour = null;
        let maxArea = 0;
        for (let i = 0; i < contours.size(); i++) {
          const area = cv.contourArea(contours.get(i));
          if (area > maxArea) {
            maxArea = area;
            largestContour = contours.get(i);
          }
        }

        if (largestContour) {
          const moments = cv.moments(largestContour);
          const cx = Math.floor(moments.m10 / moments.m00);
          const cy = Math.floor(moments.m01 / moments.m00);

          selectedX = cx;
          selectedY = cy;

          drawCircleAtSelected();
          updateColorAtSelected();

          rocheResult.textContent += " üü° (‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)";
        } else {
          errorMessage.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÑ‡∏Ç‡πà‡πÅ‡∏î‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏û";
          errorMessage.style.display = "block";
        }

        lower.delete(); upper.delete(); dst.delete(); src.delete();
        mask.delete(); contours.delete(); hierarchy.delete();
      } catch (err) {
        console.error(err);
        errorMessage.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û: " + err.message;
        errorMessage.style.display = "block";
        src.delete(); dst.delete(); mask.delete();
      }
    }
  </script>

</body>
</html>


